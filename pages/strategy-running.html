<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=393, height=852, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QuantTool - 策略监控</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="../js/mock-data.js"></script>
    <style>
        .status-banner {
            padding: 16px;
            border-radius: 14px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-banner.running {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(34, 197, 94, 0.05) 100%);
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .status-banner.paused {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(245, 158, 11, 0.05) 100%);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .status-banner.stopped {
            background: linear-gradient(135deg, rgba(100, 116, 139, 0.15) 0%, rgba(100, 116, 139, 0.05) 100%);
            border: 1px solid rgba(100, 116, 139, 0.3);
        }

        .status-banner.error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(239, 68, 68, 0.05) 100%);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .status-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .status-icon.running {
            background: rgba(34, 197, 94, 0.2);
            color: var(--color-success);
        }

        .status-icon.paused {
            background: rgba(245, 158, 11, 0.2);
            color: var(--color-warning);
        }

        .status-icon.stopped {
            background: rgba(100, 116, 139, 0.2);
            color: var(--text-muted);
        }

        .status-icon.error {
            background: rgba(239, 68, 68, 0.2);
            color: var(--color-danger);
        }

        .status-text {
            font-size: 16px;
            font-weight: 600;
        }

        .status-meta {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .mode-badge {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
        }

        .mode-badge.paper {
            background: rgba(34, 197, 94, 0.2);
            color: var(--color-success);
        }

        .mode-badge.live {
            background: rgba(239, 68, 68, 0.2);
            color: var(--color-danger);
        }

        .error-banner {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 16px;
            display: none;
        }

        .error-banner.show {
            display: block;
        }

        .error-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .error-text {
            font-size: 13px;
            color: var(--color-danger);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .error-action {
            padding: 6px 12px;
            background: var(--color-danger);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }

        .funds-card {
            background: var(--bg-card);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .funds-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .funds-title {
            font-size: 14px;
            font-weight: 600;
        }

        .funds-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .funds-item {
            text-align: center;
            padding: 12px;
            background: var(--bg-input);
            border-radius: 10px;
        }

        .funds-value {
            font-size: 20px;
            font-weight: 700;
        }

        .funds-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .funds-bar {
            height: 6px;
            background: var(--bg-input);
            border-radius: 3px;
            margin-top: 12px;
            overflow: hidden;
        }

        .funds-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary), #8B5CF6);
            border-radius: 3px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        .metric-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 14px 10px;
            text-align: center;
        }

        .metric-value {
            font-size: 18px;
            font-weight: 700;
        }

        .metric-label {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .section-title {
            font-size: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title i {
            color: var(--color-primary);
        }

        .position-card {
            background: var(--bg-card);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .position-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .position-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .position-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .position-side {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }

        .position-side.long {
            background: rgba(34, 197, 94, 0.15);
            color: var(--color-success);
        }

        .position-side.short {
            background: rgba(239, 68, 68, 0.15);
            color: var(--color-danger);
        }

        .position-pair {
            font-weight: 600;
        }

        .position-size {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .position-pnl {
            text-align: right;
        }

        .position-pnl-value {
            font-weight: 600;
        }

        .order-card {
            background: var(--bg-card);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .order-type {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .order-type.buy {
            background: rgba(34, 197, 94, 0.15);
            color: var(--color-success);
        }

        .order-type.sell {
            background: rgba(239, 68, 68, 0.15);
            color: var(--color-danger);
        }

        .order-info {
            flex: 1;
            margin-left: 10px;
        }

        .order-pair {
            font-size: 13px;
            font-weight: 500;
        }

        .order-time {
            font-size: 11px;
            color: var(--text-muted);
        }

        .order-details {
            text-align: right;
        }

        .order-price {
            font-size: 13px;
            font-weight: 500;
        }

        .order-size {
            font-size: 11px;
            color: var(--text-muted);
        }

        .risk-log-card {
            background: var(--bg-card);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .risk-item {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .risk-item:last-child {
            border-bottom: none;
        }

        .risk-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .risk-icon.warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--color-warning);
        }

        .risk-icon.danger {
            background: rgba(239, 68, 68, 0.15);
            color: var(--color-danger);
        }

        .risk-icon.info {
            background: rgba(99, 102, 241, 0.15);
            color: var(--color-primary);
        }

        .risk-content {
            flex: 1;
        }

        .risk-reason {
            font-size: 13px;
            font-weight: 500;
        }

        .risk-action {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .risk-time {
            font-size: 11px;
            color: var(--text-muted);
        }

        .control-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px;
            background: var(--bg-primary);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
        }

        .control-btn {
            flex: 1;
            padding: 14px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            border: none;
        }

        .control-btn.pause {
            background: rgba(245, 158, 11, 0.15);
            color: var(--color-warning);
        }

        .control-btn.resume {
            background: rgba(34, 197, 94, 0.15);
            color: var(--color-success);
        }

        .control-btn.stop {
            background: rgba(100, 116, 139, 0.15);
            color: var(--text-secondary);
        }

        .control-btn.emergency {
            background: rgba(239, 68, 68, 0.15);
            color: var(--color-danger);
        }

        .empty-state {
            text-align: center;
            padding: 24px;
            color: var(--text-muted);
            font-size: 13px;
        }

        .empty-state i {
            font-size: 24px;
            margin-bottom: 8px;
            opacity: 0.5;
        }

        .tab-switch {
            display: flex;
            background: var(--bg-card);
            border-radius: 10px;
            padding: 4px;
            margin-bottom: 12px;
        }

        .tab-switch-item {
            flex: 1;
            padding: 8px;
            text-align: center;
            font-size: 13px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-switch-item.active {
            background: var(--color-primary);
            color: white;
        }
    </style>
</head>

<body>
    <!-- 动态岛 -->
    <div class="dynamic-island"></div>

    <!-- iOS状态栏 -->
    <div class="status-bar">
        <span class="status-bar-time">00:45</span>
        <div class="status-bar-icons">
            <i class="fas fa-signal"></i>
            <i class="fas fa-wifi"></i>
            <i class="fas fa-battery-full battery"></i>
        </div>
    </div>

    <!-- 主内容区 -->
    <div class="main-content">
        <!-- 导航栏 -->
        <div class="page-header" style="padding-bottom: 8px;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <a href="strategies.html" style="color: var(--text-primary); font-size: 20px;">
                    <i class="fas fa-chevron-left"></i>
                </a>
                <span style="font-size: 17px; font-weight: 600;" id="pageTitle">策略监控</span>
            </div>
            <button class="btn btn-secondary btn-sm" style="padding: 8px; border-radius: 8px;"
                onclick="triggerTestRisk()">
                <i class="fas fa-bolt"></i>
            </button>
        </div>

        <div class="page-container" style="padding-top: 0;" id="content">
            <!-- 动态渲染 -->
        </div>

        <!-- 底部占位 -->
        <div style="height: 100px;"></div>
    </div>

    <!-- 控制面板 -->
    <div class="control-panel" id="controlPanel">
        <!-- 动态渲染 -->
    </div>

    <script>
        let currentRun = null;

        document.addEventListener('DOMContentLoaded', function () {
            const runId = localStorage.getItem('current_run_id');
            if (!runId) {
                showToast('未找到运行记录', 'error');
                setTimeout(() => window.location.href = 'strategies.html', 1500);
                return;
            }

            currentRun = store.getRunningStrategy(runId);
            if (!currentRun) {
                showToast('运行记录不存在', 'error');
                setTimeout(() => window.location.href = 'strategies.html', 1500);
                return;
            }

            renderDashboard();
        });

        function renderDashboard() {
            const r = currentRun;
            const m = r.metrics;
            const isRunning = r.status === 'running';
            const isPaused = r.status === 'paused';
            const isStopped = r.status === 'stopped';
            const hasError = r.error_message;

            document.getElementById('pageTitle').textContent = r.strategy_name;

            // 计算运行时长
            const startTime = new Date(r.started_at);
            const runDuration = Math.floor((Date.now() - startTime) / 1000);
            const hours = Math.floor(runDuration / 3600);
            const minutes = Math.floor((runDuration % 3600) / 60);
            const durationStr = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;

            const fundsUsedPercent = Math.round(r.funds.used / r.funds.allocated * 100) || 0;

            document.getElementById('content').innerHTML = `
                <!-- 状态栏 -->
                <div class="status-banner ${r.status}">
                    <div class="status-info">
                        <div class="status-icon ${r.status}">
                            <i class="fas fa-${isRunning ? 'play' : isPaused ? 'pause' : isStopped ? 'stop' : 'exclamation-triangle'}"></i>
                        </div>
                        <div>
                            <div class="status-text">${isRunning ? '运行中' : isPaused ? '已暂停' : isStopped ? '已停止' : '异常'}</div>
                            <div class="status-meta">${r.exchange} · ${r.account_name} · ${durationStr}</div>
                        </div>
                    </div>
                    <span class="mode-badge ${r.mode}">${r.mode === 'paper' ? '模拟盘' : '实盘'}</span>
                </div>

                <!-- 异常 Banner -->
                <div class="error-banner ${hasError ? 'show' : ''}" id="errorBanner">
                    <div class="error-content">
                        <span class="error-text">
                            <i class="fas fa-exclamation-circle"></i>
                            ${r.error_message || ''}
                        </span>
                        <button class="error-action" onclick="resumeRun()">恢复运行</button>
                    </div>
                </div>

                <!-- 资金区 -->
                <div class="funds-card">
                    <div class="funds-header">
                        <span class="funds-title"><i class="fas fa-wallet"></i> 资金状况</span>
                    </div>
                    <div class="funds-grid">
                        <div class="funds-item">
                            <div class="funds-value">$${r.funds.allocated.toLocaleString()}</div>
                            <div class="funds-label">分配资金</div>
                        </div>
                        <div class="funds-item">
                            <div class="funds-value">$${(r.funds.allocated - r.funds.used).toLocaleString()}</div>
                            <div class="funds-label">可用余额</div>
                        </div>
                    </div>
                    <div class="funds-bar">
                        <div class="funds-bar-fill" style="width: ${fundsUsedPercent}%;"></div>
                    </div>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 6px; text-align: center;">
                        资金占用 ${fundsUsedPercent}%
                    </div>
                </div>

                <!-- 实时指标 -->
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" style="color: ${m.today_pnl >= 0 ? 'var(--color-success)' : 'var(--color-danger)'};">
                            ${m.today_pnl >= 0 ? '+' : ''}$${m.today_pnl.toFixed(2)}
                        </div>
                        <div class="metric-label">今日收益</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" style="color: ${m.total_return >= 0 ? 'var(--color-success)' : 'var(--color-danger)'};">
                            ${m.total_return >= 0 ? '+' : ''}${m.total_return_percent}%
                        </div>
                        <div class="metric-label">累计收益</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" style="color: var(--color-danger);">-${m.max_drawdown}%</div>
                        <div class="metric-label">最大回撤</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${m.win_rate}%</div>
                        <div class="metric-label">胜率</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${m.trade_count}</div>
                        <div class="metric-label">交易次数</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${r.positions.length > 0 ? (r.positions[0].side === 'long' ? '多' : '空') : '-'}</div>
                        <div class="metric-label">持仓方向</div>
                    </div>
                </div>

                <!-- 持仓 -->
                <div class="section-header">
                    <span class="section-title"><i class="fas fa-chart-pie"></i> 当前持仓</span>
                </div>
                <div class="position-card">
                    ${r.positions.length > 0 ? r.positions.map(p => `
                        <div class="position-item">
                            <div class="position-info">
                                <span class="position-side ${p.side}">${p.side === 'long' ? '多' : '空'}</span>
                                <div>
                                    <div class="position-pair">${p.pair}</div>
                                    <div class="position-size">${p.size} @ $${p.entry_price.toLocaleString()}</div>
                                </div>
                            </div>
                            <div class="position-pnl">
                                <div class="position-pnl-value" style="color: ${p.unrealized_pnl >= 0 ? 'var(--color-success)' : 'var(--color-danger)'};">
                                    ${p.unrealized_pnl >= 0 ? '+' : ''}$${p.unrealized_pnl.toFixed(2)}
                                </div>
                                <div style="font-size: 11px; color: var(--text-muted);">未实现盈亏</div>
                            </div>
                        </div>
                    `).join('') : `
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <div>暂无持仓</div>
                        </div>
                    `}
                </div>

                <!-- 订单 -->
                <div class="section-header">
                    <span class="section-title"><i class="fas fa-exchange-alt"></i> 订单记录</span>
                </div>
                <div class="tab-switch">
                    <div class="tab-switch-item active" onclick="showOrderTab('open')">挂单 (${r.orders.filter(o => o.status === 'open').length})</div>
                    <div class="tab-switch-item" onclick="showOrderTab('trades')">成交 (${r.recent_trades.length})</div>
                </div>
                <div class="order-card" id="orderContent">
                    ${renderOpenOrders(r.orders.filter(o => o.status === 'open'))}
                </div>

                <!-- 风控日志 -->
                <div class="section-header">
                    <span class="section-title"><i class="fas fa-shield-alt"></i> 风控日志</span>
                </div>
                <div class="risk-log-card">
                    ${r.risk_events.length > 0 ? r.risk_events.slice(0, 5).map(e => `
                        <div class="risk-item">
                            <div class="risk-icon ${e.action === 'paused' ? 'danger' : e.action === 'alert' ? 'warning' : 'info'}">
                                <i class="fas fa-${e.action === 'paused' ? 'pause' : e.action === 'alert' ? 'exclamation' : 'info'}"></i>
                            </div>
                            <div class="risk-content">
                                <div class="risk-reason">${e.reason}</div>
                                <div class="risk-action">${e.action === 'paused' ? '策略已暂停' : e.action === 'all_positions_closed' ? '已平仓' : '警告提示'}</div>
                            </div>
                            <div class="risk-time">${new Date(e.triggered_at).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}</div>
                        </div>
                    `).join('') : `
                        <div class="empty-state">
                            <i class="fas fa-check-circle"></i>
                            <div>暂无风控事件</div>
                        </div>
                    `}
                </div>
            `;

            // 渲染控制面板
            renderControlPanel();
        }

        function renderOpenOrders(orders) {
            if (orders.length === 0) {
                return `<div class="empty-state"><i class="fas fa-inbox"></i><div>暂无挂单</div></div>`;
            }
            return orders.map(o => `
                <div class="order-item">
                    <div class="order-type ${o.side}">
                        <i class="fas fa-arrow-${o.side === 'buy' ? 'down' : 'up'}"></i>
                    </div>
                    <div class="order-info">
                        <div class="order-pair">${o.pair} · ${o.side === 'buy' ? '买入' : '卖出'}</div>
                        <div class="order-time">${new Date(o.created_at).toLocaleString('zh-CN', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</div>
                    </div>
                    <div class="order-details">
                        <div class="order-price">$${o.price.toLocaleString()}</div>
                        <div class="order-size">${o.size}</div>
                    </div>
                </div>
            `).join('');
        }

        function renderTrades(trades) {
            if (trades.length === 0) {
                return `<div class="empty-state"><i class="fas fa-inbox"></i><div>暂无成交</div></div>`;
            }
            return trades.map(t => `
                <div class="order-item">
                    <div class="order-type ${t.side}">
                        <i class="fas fa-arrow-${t.side === 'buy' ? 'down' : 'up'}"></i>
                    </div>
                    <div class="order-info">
                        <div class="order-pair">${t.pair} · ${t.side === 'buy' ? '买入' : '卖出'}</div>
                        <div class="order-time">${new Date(t.executed_at).toLocaleString('zh-CN', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</div>
                    </div>
                    <div class="order-details">
                        <div class="order-price" style="color: ${t.pnl >= 0 ? 'var(--color-success)' : 'var(--color-danger)'};">
                            ${t.pnl >= 0 ? '+' : ''}$${t.pnl.toFixed(2)}
                        </div>
                        <div class="order-size">${t.size} @ $${t.price}</div>
                    </div>
                </div>
            `).join('');
        }

        function showOrderTab(tab) {
            document.querySelectorAll('.tab-switch-item').forEach((item, idx) => {
                item.classList.toggle('active', (tab === 'open' && idx === 0) || (tab === 'trades' && idx === 1));
            });

            if (tab === 'open') {
                document.getElementById('orderContent').innerHTML = renderOpenOrders(currentRun.orders.filter(o => o.status === 'open'));
            } else {
                document.getElementById('orderContent').innerHTML = renderTrades(currentRun.recent_trades);
            }
        }

        function renderControlPanel() {
            const isRunning = currentRun.status === 'running';
            const isPaused = currentRun.status === 'paused';
            const isStopped = currentRun.status === 'stopped';

            let buttons = '';
            if (isRunning) {
                buttons = `
                    <button class="control-btn pause" onclick="pauseRun()"><i class="fas fa-pause"></i> 暂停</button>
                    <button class="control-btn stop" onclick="stopRun()"><i class="fas fa-stop"></i> 停止</button>
                    <button class="control-btn emergency" onclick="emergencyCloseRun()"><i class="fas fa-fire"></i> 平仓</button>
                `;
            } else if (isPaused) {
                buttons = `
                    <button class="control-btn resume" onclick="resumeRun()"><i class="fas fa-play"></i> 恢复</button>
                    <button class="control-btn stop" onclick="stopRun()"><i class="fas fa-stop"></i> 停止</button>
                    <button class="control-btn emergency" onclick="emergencyCloseRun()"><i class="fas fa-fire"></i> 平仓</button>
                `;
            } else {
                buttons = `
                    <button class="control-btn" style="background: var(--bg-card); color: var(--text-muted); flex: 1;" onclick="window.location.href='strategies.html'">
                        <i class="fas fa-arrow-left"></i> 返回策略列表
                    </button>
                `;
            }

            document.getElementById('controlPanel').innerHTML = buttons;
        }

        function pauseRun() {
            const result = store.pauseStrategy(currentRun.run_id);
            if (result.success) {
                showToast('策略已暂停', 'info');
                currentRun = store.getRunningStrategy(currentRun.run_id);
                renderDashboard();
            } else {
                showToast(result.message, 'error');
            }
        }

        function resumeRun() {
            const result = store.resumeStrategy(currentRun.run_id);
            if (result.success) {
                showToast('策略已恢复运行', 'success');
                currentRun = store.getRunningStrategy(currentRun.run_id);
                renderDashboard();
            } else {
                showToast(result.message, 'error');
            }
        }

        function stopRun() {
            if (confirm('确定要停止策略吗？停止后资金将被释放。')) {
                const result = store.stopStrategy(currentRun.run_id);
                if (result.success) {
                    showToast('策略已停止', 'info');
                    currentRun = store.getRunningStrategy(currentRun.run_id);
                    renderDashboard();
                } else {
                    showToast(result.message, 'error');
                }
            }
        }

        function emergencyCloseRun() {
            if (confirm('确定要执行紧急平仓吗？将清空所有持仓并取消所有挂单。')) {
                const result = store.emergencyClose(currentRun.run_id);
                if (result.success) {
                    showToast('紧急平仓已执行', 'info');
                    currentRun = store.getRunningStrategy(currentRun.run_id);
                    renderDashboard();
                } else {
                    showToast(result.message, 'error');
                }
            }
        }

        function triggerTestRisk() {
            const eventType = ['daily_loss', 'max_drawdown', 'api_error', 'order_failed'][Math.floor(Math.random() * 4)];
            const result = store.triggerRiskEvent(currentRun.run_id, eventType);
            showToast('模拟风控触发: ' + result.message, 'warning');
            currentRun = store.getRunningStrategy(currentRun.run_id);
            renderDashboard();
        }

        function showToast(message, type = 'info') {
            const colors = {
                success: 'rgba(34, 197, 94, 0.95)',
                error: 'rgba(239, 68, 68, 0.95)',
                warning: 'rgba(245, 158, 11, 0.95)',
                info: 'rgba(99, 102, 241, 0.95)'
            };
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed; top: 70px; left: 50%; transform: translateX(-50%);
                background: ${colors[type] || colors.info}; color: white; padding: 12px 20px;
                border-radius: 12px; font-size: 14px; font-weight: 500; z-index: 1000;
                display: flex; align-items: center; gap: 8px;
            `;
            const icons = { success: 'check-circle', error: 'times-circle', warning: 'exclamation-triangle', info: 'info-circle' };
            toast.innerHTML = `<i class="fas fa-${icons[type] || icons.info}"></i> ${message}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2500);
        }
    </script>
</body>

</html>