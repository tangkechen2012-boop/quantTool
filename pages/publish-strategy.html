<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=393, height=852, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QuantTool - 发布策略</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="../js/mock-data.js"></script>
    <style>
        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 20px 0;
        }

        .step-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--border-color);
            transition: all 0.3s;
        }

        .step-dot.active {
            background: var(--color-primary);
            width: 24px;
            border-radius: 5px;
        }

        .step-dot.done {
            background: #22C55E;
        }

        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
        }

        .strategy-select-card {
            padding: 16px;
            background: var(--bg-card);
            border: 2px solid transparent;
            border-radius: 14px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .strategy-select-card:hover {
            border-color: var(--border-color);
        }

        .strategy-select-card.selected {
            border-color: var(--color-primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .strategy-select-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .strategy-select-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .strategy-select-name {
            font-size: 15px;
            font-weight: 600;
        }

        .strategy-select-status {
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 500;
        }

        .status-tested {
            background: rgba(99, 102, 241, 0.15);
            color: var(--color-primary);
        }

        .status-running {
            background: rgba(34, 197, 94, 0.15);
            color: #22C55E;
        }

        .status-paused {
            background: rgba(245, 158, 11, 0.15);
            color: #F59E0B;
        }

        .status-draft {
            background: rgba(100, 116, 139, 0.15);
            color: #64748B;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .form-label .required {
            color: #EF4444;
        }

        .textarea {
            width: 100%;
            min-height: 120px;
            padding: 14px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
        }

        .textarea:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .radio-option:hover {
            border-color: var(--color-primary);
        }

        .radio-option.selected {
            border-color: var(--color-primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .radio-option input {
            display: none;
        }

        .radio-circle {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .radio-option.selected .radio-circle {
            border-color: var(--color-primary);
            background: var(--color-primary);
        }

        .radio-option.selected .radio-circle::after {
            content: '';
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
        }

        .radio-content {
            flex: 1;
        }

        .radio-title {
            font-size: 14px;
            font-weight: 500;
        }

        .radio-desc {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .price-input-group {
            display: none;
            margin-top: 12px;
            padding: 12px;
            background: var(--bg-input);
            border-radius: 10px;
        }

        .price-input-group.show {
            display: block;
        }

        .price-input-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .price-input-row input {
            flex: 1;
            padding: 10px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .price-input-row span {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .preview-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .preview-title {
            font-size: 18px;
            font-weight: 700;
        }

        .preview-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }

        .preview-row:last-child {
            border-bottom: none;
        }

        .preview-label {
            color: var(--text-secondary);
        }

        .preview-value {
            font-weight: 500;
        }

        .action-bar {
            position: fixed;
            bottom: 83px;
            left: 0;
            right: 0;
            padding: 12px 16px;
            background: linear-gradient(180deg, transparent 0%, var(--bg-dark) 20%);
            display: flex;
            gap: 10px;
        }

        .btn-nav {
            flex: 1;
            padding: 16px;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border: none;
        }

        .btn-prev {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .btn-next {
            background: linear-gradient(135deg, var(--color-primary) 0%, #8B5CF6 100%);
            color: white;
        }

        .btn-next:disabled {
            background: var(--bg-card);
            color: var(--text-muted);
        }

        .success-animation {
            text-align: center;
            padding: 60px 20px;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #22C55E 0%, #16A34A 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            font-size: 36px;
            color: white;
            animation: scaleIn 0.5s ease;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0);
            }

            to {
                transform: scale(1);
            }
        }

        .success-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .success-desc {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }
    </style>
</head>

<body>
    <!-- 动态岛 -->
    <div class="dynamic-island"></div>

    <!-- iOS状态栏 -->
    <div class="status-bar">
        <span class="status-bar-time">21:46</span>
        <div class="status-bar-icons">
            <i class="fas fa-signal"></i>
            <i class="fas fa-wifi"></i>
            <i class="fas fa-battery-full battery"></i>
        </div>
    </div>

    <!-- 主内容区 -->
    <div class="main-content" style="padding-bottom: 160px;">
        <!-- 导航栏 -->
        <div class="page-header" style="padding-bottom: 8px;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <a href="strategies.html" style="color: var(--text-primary); font-size: 20px;" id="backBtn">
                    <i class="fas fa-chevron-left"></i>
                </a>
                <span style="font-size: 17px; font-weight: 600;" id="pageTitle">发布策略</span>
            </div>
            <div></div>
        </div>

        <!-- 步骤指示器 -->
        <div class="step-indicator" id="stepIndicator">
            <div class="step-dot active" data-step="1"></div>
            <div class="step-dot" data-step="2"></div>
            <div class="step-dot" data-step="3"></div>
            <div class="step-dot" data-step="4"></div>
        </div>

        <div class="page-container" style="padding-top: 0;">
            <!-- Step 1: 选择策略 -->
            <div class="step-content active" id="step1">
                <h3 style="font-size: 18px; margin-bottom: 4px;">选择要发布的策略</h3>
                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 20px;">只有已完成回测的策略才能发布到市场</p>

                <div id="strategyList">
                    <!-- 动态渲染 -->
                </div>
            </div>

            <!-- Step 2: 填写信息 -->
            <div class="step-content" id="step2">
                <h3 style="font-size: 18px; margin-bottom: 4px;">填写策略信息</h3>
                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 20px;">完善策略描述，帮助用户了解您的策略</p>

                <div class="form-group">
                    <label class="form-label">策略简介 <span class="required">*</span></label>
                    <textarea class="textarea" id="summary" placeholder="描述您的策略特点、适用场景等（支持 Markdown）"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">适合行情</label>
                    <input type="text" class="input" id="suitableMarket" placeholder="如：震荡行情、单边趋势">
                </div>

                <div class="form-group">
                    <label class="form-label">交易逻辑简述</label>
                    <textarea class="textarea" id="logic" placeholder="简要描述策略的交易逻辑（无需代码）"
                        style="min-height: 80px;"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">风险提示 <span class="required">*</span></label>
                    <textarea class="textarea" id="riskWarning" placeholder="提醒用户可能的风险"
                        style="min-height: 80px;"></textarea>
                </div>
            </div>

            <!-- Step 3: 设置定价 -->
            <div class="step-content" id="step3">
                <h3 style="font-size: 18px; margin-bottom: 4px;">选择风险等级</h3>
                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 20px;">为您的策略设置风险等级</p>

                <div class="radio-group" id="riskLevelGroup" style="margin-bottom: 24px;">
                    <label class="radio-option" onclick="selectRadio(this, 'risk')">
                        <input type="radio" name="risk" value="conservative">
                        <div class="radio-circle"></div>
                        <div class="radio-content">
                            <div class="radio-title" style="color: #22C55E;">稳健型</div>
                            <div class="radio-desc">低风险低收益，适合保守型投资者</div>
                        </div>
                    </label>
                    <label class="radio-option selected" onclick="selectRadio(this, 'risk')">
                        <input type="radio" name="risk" value="balanced" checked>
                        <div class="radio-circle"></div>
                        <div class="radio-content">
                            <div class="radio-title" style="color: #F59E0B;">平衡型</div>
                            <div class="radio-desc">风险收益适中，适合大多数投资者</div>
                        </div>
                    </label>
                    <label class="radio-option" onclick="selectRadio(this, 'risk')">
                        <input type="radio" name="risk" value="aggressive">
                        <div class="radio-circle"></div>
                        <div class="radio-content">
                            <div class="radio-title" style="color: #EF4444;">激进型</div>
                            <div class="radio-desc">高风险高收益，适合风险偏好高的投资者</div>
                        </div>
                    </label>
                </div>

                <h3 style="font-size: 18px; margin-bottom: 4px;">设置定价模式</h3>
                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 20px;">选择策略的收费方式</p>

                <div class="radio-group" id="pricingGroup">
                    <label class="radio-option selected" onclick="selectRadio(this, 'pricing')">
                        <input type="radio" name="pricing" value="free" checked>
                        <div class="radio-circle"></div>
                        <div class="radio-content">
                            <div class="radio-title">免费</div>
                            <div class="radio-desc">所有用户可免费使用</div>
                        </div>
                    </label>
                    <label class="radio-option" onclick="selectRadio(this, 'pricing')">
                        <input type="radio" name="pricing" value="subscription">
                        <div class="radio-circle"></div>
                        <div class="radio-content">
                            <div class="radio-title">月订阅</div>
                            <div class="radio-desc">用户按月付费使用</div>
                        </div>
                    </label>
                    <div class="price-input-group" id="subscriptionPrice">
                        <div class="price-input-row">
                            <span>$</span>
                            <input type="number" id="monthlyPrice" placeholder="29.99" step="0.01" min="0">
                            <span>/月</span>
                        </div>
                    </div>
                    <label class="radio-option" onclick="selectRadio(this, 'pricing')">
                        <input type="radio" name="pricing" value="profit_share">
                        <div class="radio-circle"></div>
                        <div class="radio-content">
                            <div class="radio-title">收益分成</div>
                            <div class="radio-desc">按用户收益的一定比例收取</div>
                        </div>
                    </label>
                    <div class="price-input-group" id="shareRatioInput">
                        <div class="price-input-row">
                            <input type="number" id="shareRatio" placeholder="15" step="1" min="1" max="50">
                            <span>% 收益分成</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 4: 确认发布 -->
            <div class="step-content" id="step4">
                <h3 style="font-size: 18px; margin-bottom: 4px;">确认发布信息</h3>
                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 20px;">请确认以下信息无误后提交发布</p>

                <div class="preview-card" id="previewCard">
                    <!-- 动态渲染 -->
                </div>

                <div
                    style="background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 12px; padding: 14px; margin-bottom: 16px;">
                    <div
                        style="display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 500; color: var(--color-primary); margin-bottom: 6px;">
                        <i class="fas fa-info-circle"></i> 发布须知
                    </div>
                    <ul
                        style="font-size: 12px; color: var(--text-secondary); padding-left: 20px; margin: 0; line-height: 1.8;">
                        <li>策略发布后需经平台审核，审核通过后将上架市场</li>
                        <li>您可以随时下架或更新策略</li>
                        <li>请确保策略描述真实准确</li>
                    </ul>
                </div>
            </div>

            <!-- Step 5: 成功 -->
            <div class="step-content" id="step5">
                <div class="success-animation">
                    <div class="success-icon">
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="success-title">发布成功！</div>
                    <div class="success-desc">您的策略已提交审核，审核通过后将上架市场</div>
                    <button class="btn btn-primary btn-block" onclick="window.location.href='marketplace.html'">
                        <i class="fas fa-store"></i> 前往市场查看
                    </button>
                    <button class="btn btn-secondary btn-block mt-3" onclick="window.location.href='strategies.html'">
                        <i class="fas fa-list"></i> 返回我的策略
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 操作栏 -->
    <div class="action-bar" id="actionBar">
        <button class="btn-nav btn-prev" id="prevBtn" onclick="prevStep()" style="display: none;">
            <i class="fas fa-chevron-left"></i> 上一步
        </button>
        <button class="btn-nav btn-next" id="nextBtn" onclick="nextStep()">
            下一步 <i class="fas fa-chevron-right"></i>
        </button>
    </div>

    <!-- 底部Tab Bar -->
    <div class="tab-bar">
        <a href="home.html" class="tab-item">
            <i class="fas fa-home"></i>
            <span>首页</span>
        </a>
        <a href="strategies.html" class="tab-item active">
            <i class="fas fa-cube"></i>
            <span>策略</span>
        </a>
        <a href="marketplace.html" class="tab-item">
            <i class="fas fa-store"></i>
            <span>市场</span>
        </a>
        <a href="ai-strategy.html" class="tab-item">
            <i class="fas fa-robot"></i>
            <span>AI</span>
        </a>
        <a href="accounts.html" class="tab-item">
            <i class="fas fa-wallet"></i>
            <span>账户</span>
        </a>
    </div>

    <script>
        let currentStep = 1;
        let selectedStrategy = null;
        const totalSteps = 4;

        document.addEventListener('DOMContentLoaded', function () {
            renderStrategyList();
            updatePriceInputs();
        });

        function renderStrategyList() {
            const strategies = store.getMyStrategies();
            const container = document.getElementById('strategyList');

            container.innerHTML = strategies.map(s => {
                const canPublish = ['tested', 'running', 'paused'].includes(s.status);
                const statusLabels = {
                    draft: '草稿',
                    saved: '已保存',
                    tested: '已回测',
                    running: '运行中',
                    paused: '已暂停',
                    error: '异常'
                };

                return `
          <div class="strategy-select-card ${!canPublish ? 'disabled' : ''}" 
               onclick="${canPublish ? `selectStrategy('${s.id}')` : ''}">
            <div class="strategy-select-header">
              <span class="strategy-select-name">${s.name}</span>
              <span class="strategy-select-status status-${s.status}">${statusLabels[s.status]}</span>
            </div>
            <div style="display: flex; gap: 16px; font-size: 12px; color: var(--text-secondary);">
              <span><i class="fas fa-chart-line"></i> ${s.performance.return_total >= 0 ? '+' : ''}${s.performance.return_total}%</span>
              <span><i class="fas fa-clock"></i> ${s.running_days} 天</span>
              <span style="color: ${s.source === 'market' ? '#F59E0B' : 'inherit'};">
                ${s.source === 'market' ? '市场策略' : '自建策略'}
              </span>
            </div>
            ${!canPublish ? '<div style="font-size: 11px; color: #EF4444; margin-top: 8px;"><i class="fas fa-exclamation-circle"></i> 需先完成回测才能发布</div>' : ''}
          </div>
        `;
            }).join('');
        }

        function selectStrategy(id) {
            selectedStrategy = store.getMyStrategies().find(s => s.id === id);
            document.querySelectorAll('.strategy-select-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            updateNextButton();
        }

        function selectRadio(element, group) {
            const container = element.closest('.radio-group');
            container.querySelectorAll('.radio-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            element.classList.add('selected');
            element.querySelector('input').checked = true;

            if (group === 'pricing') {
                updatePriceInputs();
            }
        }

        function updatePriceInputs() {
            const pricingType = document.querySelector('input[name="pricing"]:checked')?.value;
            document.getElementById('subscriptionPrice').classList.toggle('show', pricingType === 'subscription');
            document.getElementById('shareRatioInput').classList.toggle('show', pricingType === 'profit_share');
        }

        function updateNextButton() {
            const nextBtn = document.getElementById('nextBtn');
            let canProceed = true;

            if (currentStep === 1) {
                canProceed = selectedStrategy !== null;
            } else if (currentStep === 2) {
                canProceed = document.getElementById('summary').value.trim() !== '' &&
                    document.getElementById('riskWarning').value.trim() !== '';
            } else if (currentStep === 3) {
                const pricingType = document.querySelector('input[name="pricing"]:checked')?.value;
                if (pricingType === 'subscription') {
                    canProceed = parseFloat(document.getElementById('monthlyPrice').value) > 0;
                } else if (pricingType === 'profit_share') {
                    canProceed = parseFloat(document.getElementById('shareRatio').value) > 0;
                }
            }

            nextBtn.disabled = !canProceed;
        }

        function nextStep() {
            if (currentStep === 4) {
                publishStrategy();
                return;
            }

            currentStep++;
            updateStepUI();

            if (currentStep === 4) {
                renderPreview();
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepUI();
            }
        }

        function updateStepUI() {
            // 更新步骤指示器
            document.querySelectorAll('.step-dot').forEach((dot, i) => {
                dot.classList.remove('active', 'done');
                if (i + 1 < currentStep) dot.classList.add('done');
                if (i + 1 === currentStep) dot.classList.add('active');
            });

            // 更新内容显示
            document.querySelectorAll('.step-content').forEach((content, i) => {
                content.classList.toggle('active', i + 1 === currentStep);
            });

            // 更新按钮
            document.getElementById('prevBtn').style.display = currentStep === 1 ? 'none' : 'flex';
            document.getElementById('nextBtn').innerHTML = currentStep === 4
                ? '<i class="fas fa-paper-plane"></i> 提交发布'
                : '下一步 <i class="fas fa-chevron-right"></i>';

            updateNextButton();
        }

        function renderPreview() {
            const pricingType = document.querySelector('input[name="pricing"]:checked')?.value;
            const riskLevel = document.querySelector('input[name="risk"]:checked')?.value;

            let pricingText = '免费';
            if (pricingType === 'subscription') {
                pricingText = `$${document.getElementById('monthlyPrice').value}/月`;
            } else if (pricingType === 'profit_share') {
                pricingText = `收益分成 ${document.getElementById('shareRatio').value}%`;
            }

            const riskLabels = { conservative: '稳健型', balanced: '平衡型', aggressive: '激进型' };

            document.getElementById('previewCard').innerHTML = `
        <div class="preview-header">
          <span class="preview-title">${selectedStrategy.name}</span>
          <span style="padding: 4px 10px; background: rgba(245, 158, 11, 0.15); color: #F59E0B; border-radius: 8px; font-size: 11px;">待审核</span>
        </div>
        <div class="preview-row">
          <span class="preview-label">策略类型</span>
          <span class="preview-value">${store.getTypeLabel(selectedStrategy.type)}</span>
        </div>
        <div class="preview-row">
          <span class="preview-label">风险等级</span>
          <span class="preview-value">${riskLabels[riskLevel]}</span>
        </div>
        <div class="preview-row">
          <span class="preview-label">定价模式</span>
          <span class="preview-value">${pricingText}</span>
        </div>
        <div class="preview-row">
          <span class="preview-label">回测收益</span>
          <span class="preview-value" style="color: ${selectedStrategy.performance.return_total >= 0 ? '#22C55E' : '#EF4444'}">
            ${selectedStrategy.performance.return_total >= 0 ? '+' : ''}${selectedStrategy.performance.return_total}%
          </span>
        </div>
        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
          <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">策略简介</div>
          <div style="font-size: 13px; line-height: 1.6;">${document.getElementById('summary').value}</div>
        </div>
      `;
        }

        function publishStrategy() {
            const pricingType = document.querySelector('input[name="pricing"]:checked')?.value;
            const riskLevel = document.querySelector('input[name="risk"]:checked')?.value;

            const publishInfo = {
                risk_level: riskLevel,
                pricing: {
                    type: pricingType,
                    price_monthly: pricingType === 'subscription' ? parseFloat(document.getElementById('monthlyPrice').value) : null,
                    share_ratio: pricingType === 'profit_share' ? parseInt(document.getElementById('shareRatio').value) : null
                },
                summary: document.getElementById('summary').value,
                suitable_market: document.getElementById('suitableMarket').value || '通用行情',
                logic: document.getElementById('logic').value || '暂无详细说明',
                risk_warning: document.getElementById('riskWarning').value
            };

            const result = store.publishStrategy(selectedStrategy.id, publishInfo);

            if (result.success) {
                currentStep = 5;
                document.querySelectorAll('.step-content').forEach(c => c.classList.remove('active'));
                document.getElementById('step5').classList.add('active');
                document.getElementById('stepIndicator').style.display = 'none';
                document.getElementById('actionBar').style.display = 'none';
                document.getElementById('pageTitle').textContent = '发布成功';
            } else {
                showToast(result.message, 'error');
            }
        }

        // 监听输入变化
        document.querySelectorAll('input, textarea').forEach(el => {
            el.addEventListener('input', updateNextButton);
        });
    </script>
</body>

</html>